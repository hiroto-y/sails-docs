# 「Dominance」
## エンティティの例


```javascript
// User.js
module.exports = {
  connection: 'ourMySQL',
  attributes: {
    email: 'string',
    wishlist: {
      collection: 'product',
      via: 'wishlistedBy'
    }
  }
};
```


```javascript
// Product.js
module.exports = {
  connection: 'ourRedis',
  attributes: {
    name: 'string',
    wishlistedBy: {
      collection: 'user',
      via: 'wishlist'
    }
  }
};
```

### 問題

このアダプタをまたがるデータ間での理レーヨンに何が起こっているのかは簡単にわかります。個々には多対多( `N->...` ) のリレーションが商品とユーザの間にあります。実際はその他のリレーション(購入等)があるとお考えになると思いますが、それらはミドルマンモデルを使ういい例だと思いますのでこの例ではよりシンプルにしました。

これらはすいつも全て素晴らしいですが。。。リレーションリソースは何処にあるのでしょうか。SQL的な命名法によると”ProductUser”ですね。我々はこれがどちらかの一方にあるというのはわかりますが、どっちのデータベースにあるべきなのかをコントロールしたいときはどうしましょうか。

> **重要な備考**
>
> これは _アソシエーションの両方のモデルが`via`モディファイアの指定を持っているゆえに起こる問題です_ !!
> もし`via`がなければコレクションアトリビュートは常に`dominant: true`として振る舞います。
> さらなる情報は以下のFAQを御覧ください。


## 解決策

最終的にはジョインテーブルに使う第3のコネクション・アダプタがあることすらありえますが、とりあえずのところはどちらかの側にあるのかを選ぶことに焦点を当てます。


ここではこれをドミナンスのコンセプトを通して説明します。全てのクロスアダプタモードのリレーションにおいてどちらかの側がドミナントとみなされます。これは多国籍な両親から生まれた子供がどちらかの [国籍](http://en.wikipedia.org/wiki/Japanese_nationality_law)を選ばなければならない例に例えれば考えやすいでしょう。


再びリレーションの例ですが今回はMySQLデータベースがドミナントであると明確に示しています。これは"ProductUser" リレーション「テーブル」がMySQLテーブルとして保存されるということです。


```javascript
// User.js
module.exports = {
  connection: 'ourMySQL',
  attributes: {
    email: 'string',
    wishlist: {
      collection: 'product',
      via: 'wishlistedBy',
      dominant: true
    }
  }
};
```


```javascript
// Product.js
module.exports = {
  connection: 'ourRedis',
  attributes: {
    name: 'string',
    wishlistedBy: {
      collection: 'user',
      via: 'wishlist'
    }
  }
};
```


## 「ドミナント」を選ぶ

この判断にはいくつかの要因が関与します:

+ 片側がSQLデータベースである場合、もう一方にコミュニケーションする前にリレーションテーブルをジョインすることが出来るため、SQLの側ににリレーションテーブルを置くほうがクエリを効率化出来ます。これは必要な総クエリ数を3から2に減少させます。
+ もしあるコネクションが他のコネクションより速い場合、その他の条件が同様であればそのコネクションに置くほうがいいでしょう。
+ 一方のコネクションにマイグレートするほうが簡単な場合、マイグレート先の方を `dominant`とすべきでしょう。同様に規制やコンプライアンスの問題が判断に影響します。もしリレーションがセンシティブな患者情報を含む場合(例えば`Patient`と`Medicine`のリレーションのように)関係する全てのデータが一つの特定のデータベースに保存されているようにしたいでしょう(このケースではおそらく`Patient`を`dominant`にするでしょう)。
+ これらに加えて、一方のコネクションが読み込み専用(前の例の`Medicine`は製薬会社の読み込み専用データベースかもしれません)で書き込めない場合、そうでない方においてリレーションがきちんと保存されるようにすべきでしょう。


## FAQ


##### どちらかのコレクションが`via`を持たなければどうなりますか?

> もし`collection`のアソシエーションが`via`プロパティを満たない時は自動的に`dominant: true`になります。


##### 両方のコレクションが`via`を持たなければどうなりますか?

> もし両方の`collections`が`via`を持たなければリレーションは張られません。両方が`dominant`です。なぜならそれぞれ別別のリレーションテーブルだからです。

##### `model`のアソシエーションはどうですか?

> その他のタイプのアソシエーションにおいて`dominant`プロパティの仕様は禁止されています。片方に`dominant`を設定することは`{ via: '...', collection: '...' }`のようなアトリビュートを両方に持つ2つのモデルのアソシエーションにのみ必要です


##### モデルは一つのアトリビュートのドミナントになって別のもののドミナントにならないことは出来ますか。
> モデルのドミナントは特定のリレーションについてのみの文脈であることを覚えておいてください。モデルは一つまたは複数のリレーション(アトリビュート)においてドミナントになり、別のリレーション(アトリビュート)に関してドミナントにならないということが出来ます。
> 例　もし`User`が`Toy`モデル上の`favoriteToyOf`を通じて`favoriteToys`と呼ばれるコレクションを持ち、`User`の`favoriteToys`は`dominant: true`の時`Toy`は依然として別の方面でドミナントになることが出来ます。`Toy` は`User`に `designedBy`アトリビュートを通じてもリレーションしており、そのドミナントが`dominant: true`であるという場合です。


##### 両方のモデルがドミナントになれますか?

> いいえ。クロスアダプタ・クロスコネクションの多対多アソシエーションにおいてもし両方のモデルが`dominant: true`に設定されている場合は起動前にエラーが出力されます。


##### どちらもドミナントにしないことは可能ですか?

> 一応出来ます。。。もしクロスアダプタ・クロスコネクションの多対多アソシエーションに置いてどちらのモデルも`dominant: true`にセットされなかった場合起動前に警告が出ます、そしてリレーションの文字列のアルファベット順に自動的に生成されるはずです。今のところは単にアルファベット順による恣意的な判断です。 :)

##### クロスアダプタではないリレーションの場合はどうですか?

> 非クロスアダプタ・非クロスコネクションのアソシエーションでは`dominant`のプロパティは静かに無視されます。我々は皆さんがいずれスキーマを複数のコネクションに分けることを考えているのではないかと思いますし、その準備を前もって行っておくことを邪魔する理由はありません。それに、これは将来の"dominant"の将来的な利用を予約するものですので。


<docmeta name="uniqueID" value="Dominance904539">
<docmeta name="displayName" value="Dominance">

